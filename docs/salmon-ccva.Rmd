---
title: "Climate Change Vulnerability Assessments for Pacific Salmon & Steelhead in Canada"
subtitle: "Supplemental Information"
author: "Steph Peacock, Salmon Watersheds Program, Pacific Salmon Foundation"
date: "`r Sys.Date()`"
bibliography: references.json
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl 
link-citations: true
header-includes:
   - \usepackage{draftwatermark}
output: 
 html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
  # word_document:
editor_options: 
  chunk_output_type: console
runtime: shiny
---

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(echo = TRUE)

```

<head>

<meta name="robots" content="noindex">

</head>

```{=html}
<style type="text/css">

.watermark {
  opacity: 0.2;
  position: fixed;
  top: 50%;
  left: 50%;
  font-size: 500%;
  color: #000000;
}

.blackbox {
 padding: 1em;
  background: black;
  color: white;
  border: 2px solid red;
  border-radius: 10px;
}
.center {
  text-align: center;
}

</style>
```



# Background

This interactive document contains **Supplemental Information** that accompany the paper "Climate Change Vulnerability Assessments for Pacific Salmon & Steelhead in Canada". Our goal is to quantify the relative **exposure** of different Conservation Units (CUs) to climate changes throughout their life cycles, with the aim to understand which CUs are likely to be most strongly affected and why. This information is key to informing proactive and forward-looking strategies for improving the resilience of salmon under climate change.  

This work was led by Steph Peacock with the Pacific Salmon Foundation's [Salmon Watershed Program](https://www.salmonwatersheds.ca) in collaboration with members of PSF's Climate Science Advisory Committee with funding from the BC Salmon Restoration and Innovation Fund. 

# Results

::: {.blackbox data-latex=""}
::: {.center data-latex=""}
**This work is in the draft stage and all methods & results should be considered preliminary and subject to change.**
:::

The widgets allow exploration of **draft** results for freshwater climate exposure of salmon and steelhead Conservation Units in the Fraser region. 

:::

```{r echo = FALSE, message=FALSE, warning=FALSE, results = 'hide'}

# Load packages and outputs

library(colorRamps)
library(mapproj)
library(proj4)
library(sf)
library(dplyr)
library(wesanderson)
library(ncdf4) # package for netcdf manipulation
library(zoo) # package with rollmean function
library(shiny)
library(shinyWidgets)
library(leaflet)

cols <- wes_palette("Darjeeling1")

###############################################################################
# Load background spatial layers
###############################################################################

###############################################################################
# Load variables for plotting
###############################################################################

#------------------------------------------------------------------------------
# spatial distribution
#------------------------------------------------------------------------------

# Load grid cell ids for each CU and life stage
incl.stages <- readRDS("data/incl.stages_all.rds")

# Load grid cells
grid_polys_fw <- readRDS("data/grid_polys_fw.rds")
grid_polys_mar <- readRDS("data/grid_polys_mar.rds")

#------------------------------------------------------------------------------
# Timing
#------------------------------------------------------------------------------

timing <- read.csv("data/timing-fraser_days.csv")
  
#------------------------------------------------------------------------------
# List of CUs in the PSE
#------------------------------------------------------------------------------

cuid <- unique(timing$cuid)
cu_name <- timing$cu_name_pse[match(cuid, timing$cuid)]
species_cu_name <- paste0(timing$species_name[match(cuid, timing$cuid)], ": ", cu_name)
n.CUs <- length(cuid)

cu_norear <- which(timing$species_name[match(cuid, timing$cuid)] %in% c("Pink", "Chum"))

#------------------------------------------------------------------------------
# Conservation Unit Boundaries
#------------------------------------------------------------------------------

cu_boundary <- readRDS("data/cu_boundary_fraser.rds")
cu_boundary <- cu_boundary[match(cuid, cu_boundary$CUID), ]

###############################################################################
# Load output
###############################################################################

# fw_output_summary <- readRDS("data/output/fw_output_summary.rds")

# dimensions:
#   n.CUs,
#  stages,
# c("Stream temperature" "Low flow"),
#   c("hist", "early", "mid", "late"), 
# c("rcp45" "rcp85")
#   c("median" "min"    "max"))) # among models

# Spatial output
all_spat <- readRDS("data/all_spat.rds")

#------------------------------------------------------------------------------
# Define stages
#------------------------------------------------------------------------------

stages <- c("eggs_alevin", "fw_rearing", "early_marine", "marine_rearing", "adult_migration", "spawning") 

```

## Exposure maps {#maps}
 
For CUs with broad distributions and/or long migrations, there may be considerable spatial variability in exposure to changes in stream temperature and flow. The following map shows the number of days either above temperature thresholds or below low-flow or salinity thresholds in each grid cell that is relevant to the selected CU and life stage **in the mid-century period (2040-2069) under RCP 4.5**. 

```{r echo = FALSE}

#------------------------------------------------------------------------------
# set colour palette
#------------------------------------------------------------------------------
n <- 100
col_levels <- seq(0, 1, length.out = n)
col_palette <- paste0(colorRampPalette(colors = cols[c(5,3,1)])(n + 1))

#------------------------------------------------------------------------------
# Shiny app for leaflet map
#------------------------------------------------------------------------------

ui <- fluidPage(
  br(),
  fluidRow(
    
    column(width = 6, 
           selectInput("cu", "Conservation Unit:",
                       choices = species_cu_name)
    ),
    column(width = 3, 
           selectInput("stage", "Life stage:",
                       choices = c("Incubation", "Freshwater rearing", "Early marine", "Marine rearing", "Adult freshwater migration", "Spawning"))
    ),
    
    column(width = 3,
           pickerInput(inputId = "var", 
                       label = "Climate change variable:",
                       choices = c("Stream temperature", "Low stream flow", "Sea surface temperature", "Sea surface salinity"))
    )
  ), # end fluidRow
  
  fluidRow( # Leaflet map
      column(width = 12,
             leafletOutput("map", width = "100%", height = 500)
      )
    ) # end fluidRow
    
  # input <- list(cu = "Sockeye: Bowron-Early Summer", stage = "Adult freshwater migration", var = "Stream temperature")
  )
  
  server <- function(input, output, session) {
    
    observeEvent(input$stage, {
        if(input$stage %in% c("Early marine", "Marine rearing")){
          varChoices <- c("Sea surface temperature", "Sea surface salinity")
        } else {
          varChoices <- c("Stream temperature", "Low stream flow")
        }
        updatePickerInput(
            session = session, 
            inputId = "var",
            choices = varChoices
        )
    }, ignoreInit = TRUE)
    
    
    output$map <- renderLeaflet({
      
      # Set selections
      i <- which(species_cu_name == input$cu)
      
      bounds1 <- as.numeric(st_bbox(cu_boundary[i, ]))
      
      leaflet() %>%
        addProviderTiles(providers$Esri.WorldTopoMap,
                         options = providerTileOptions(noWrap = TRUE)) %>%
        fitBounds(lng1 = bounds1[1], lat1 = bounds1[2], lng2 = bounds1[3], lat2 = bounds1[4])  %>%
        addPolygons(data = cu_boundary[i,], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0) 
      
    })
    
    #----
    # Add grid colours depending on lifestage selected
    #----
    observe({

      # Set selections
      i <- which(species_cu_name == input$cu)
      j <- match(input$stage, c("Incubation", "Freshwater rearing", "Early marine", "Marine rearing", "Adult freshwater migration", "Spawning"))
      if(j %in% c(1,2,5,6)){
        env <- 1 # Quick check for environment (1 = FW, 2 = Marine)
        k <- match(input$var, c("Stream temperature", "Low flow"))
      } else {
        env <- 2
        k <- match(input$var, c("Sea surface temperature", "Sea surface salinity"))
      }
      

    # Get relevant grid cells
    if(env == 1){
      grid_polys <- grid_polys_fw
      
      # Highlight all stages CU cells
      grid_polys_CU <- grid_polys[which(grid_polys$id %in% unique(c(incl.stages[[i, 1]], incl.stages[[i, 2]], incl.stages[[i, 5]], incl.stages[[i, 6]]))), ]
      
    } else {
      grid_polys <- grid_polys_mar
      grid_polys_CU <- grid_polys_mar[which(grid_polys_mar$id %in% incl.stages[[i, j]])]
    }
      

      bounds1 <- as.numeric(st_bbox(grid_polys_CU))

      myLeaf <- leafletProxy("map") %>%
        clearShapes() %>%
        clearControls()

      # Add all stages (no colour)
      myLeaf <-  addPolygons(myLeaf, data = grid_polys_CU, color = "#000000", weight = 1, opacity = 0.4, fillOpacity = 0)

      # # add legend
      # myLeaf <- addLegend(myLeaf, position = "topright", colors = col_palette, labels = round(c(col_levels, col_levels[n] + diff(col_levels)[1])), title = "Exposure", opacity = 0.8)

      # If a life stage is selected
      if(input$stage != "None"){
        # Highlight stage-specific grid cells
        boop <- all_spat[[i,j]][k, ]
        incl <- as.numeric(names(boop))
        
        grid_polys_incl <- grid_polys[match(incl, grid_polys$id), ]

        col_polys <- col_palette[findInterval(boop, col_levels)]

        myLeaf <-  addPolygons(myLeaf, data = grid_polys_incl, color = col_polys, weight = 1, opacity = 1, fillOpacity = 0.8)
      }

      # Add CU boundary
      myLeaf <- addPolygons(myLeaf, data = cu_boundary[which(cu_boundary$CUID == cuid[i]),], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0)

      myLeaf
    })
    
  }

shinyApp(ui = ui, server = server, options = list(height = 800))


```

### Comparison among CUs
**Below**: Colour chart illustrating the median number of days in each life-stage for which a) stream temperatures are projected to be above threshold and b) low flows are projected to be below threshold in the **mid-century period (2040-2069) under RCP 4.5**. The colour scheme goes from 0 (blue) to maximum number of days among CUs for that life stage (red; adult migration = 100 days, spawning = 40 days, incubation = 150 days, freshwater rearing = 200 days).

```{r echo = FALSE, fig.height = 12}
# Order CUs according to decreasing overall exposure
 oCU <- order(apply(fw_output_summary[, , , 3, 1, 1], 1, sum, na.rm = TRUE), decreasing = FALSE)

par(mfrow = c(1,2), mar = c(6, 0, 2, 1), oma = c(0, 15, 2, 0))

for(k in 1:2){
  
  plot(c(0.5, 4.5), c(0.5, n.CUs+0.5), "n", bty = "o", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "")
  text(c(1:4), rep(-0.1, 4), stage.names[1:4], srt = 90, xpd = NA, cex =0.8, adj = 1)
  u <- par('usr')
  
  if(k == 1){
    text(rep(-6, n.CUs), c(1:n.CUs), species_cu_name[oCU], xpd = NA, adj = 0, cex = 0.8)
    abline(h = seq(0, n.CUs, 2) + 0.5, xpd = NA, col = grey(0.8))
  }
  abline(v = seq(1.5, 3.5, 1))
  
  p <- 3
  for(i in 1:n.CUs){
    for(j in 1:4){
      x <- fw_output_summary[oCU[i], j, k, p, 1, 1]
      pCol <- col_palette[findInterval(x, col_levels[, j])]
      
      polygon(x = j + c(-0.5, 0.5, 0.5, -0.5),
              y = i + c(-0.5, - 0.5, 0.5, 0.5),
              border = 1,
              col = pCol)
    }}
  mtext(side = 3, line = 0.5, c("a) Stream temperature", "b) Low flow")[k], adj = 0, cex = 0.8)
}
```

<!-- **Below**: This chart allows for a comparison of exposure (proportion of days above the temperature threshold for Stream temperature or below the a 20% MAD threshold for low flow; see [Methods](#methods)) among CUs for the selected life stage. -->

```{r echo = FALSE}
# #------------------------------------------------------------------------------
# # Shiny app for CU comparison plots
# #------------------------------------------------------------------------------
# 
# shinyApp(
# 
#   ui = fluidPage(
#     br(),
#     fluidRow(
#       column(width = 4,
#              selectInput("var", "Climate change attribute:",
#                 choices = c("Stream temperature", "Low flow"))
#              ),
#       column(width = 3, 
#               selectInput("stage", "Life stage:",
#                           choices = c("Incubation", "Freshwater rearing", "Adult freshwater migration", "Spawning"),
#                           selected = "Spawning")
#              )
#       ), # end fluidRow
#     
#    # CU comparison plot
#     plotOutput("compPlot", height = 700)
# 
#   ),
# 
#   server = function(input, output) {
#     output$compPlot = renderPlot({
# 
#       # Set selections
#       k <- match(input$var, c("Stream temperature", "Low flow"))
#       j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater rearing"))
# 
#       # Initiate plot
#       oCU <- order(fw_output_summary[ , j, k, 3, 1], decreasing = FALSE)
#   
#   par(mar = c(4, 20, 2, 1))
#   plot(c(0, 1), c(0.5, n.CUs+0.5), "n", bty = "n", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "Proportion of days")
#   u <- par('usr')
#   text(rep(-0.02*(u[2] - u[1]), n.CUs), c(1:n.CUs), cu_list$Conservation.Unit[oCU], xpd = NA, adj = 1)
#   
#   for(q in 1:n){
#     polygon(x = c(0, 1/n, 1/n, 0)+ (q-1) * 1/n, y = c(-0.5, -0.5, 0.5, 0.5), border = NA, col = col_palette[q], xpd = NA)
#   }
#   
#   axis(side = 1, tck = -0.02)
#   abline(h = c(1:n.CUs)+0.5, xpd = NA, col = grey(0.8))
#   segments(x0 = 0, y0 = 0.5, x1 = 0, y1 = n.CUs+0.5, xpd = NA)
#   segments(x0 = 0, y0 = 0.5, x1 = -10, y1 = 0.5, xpd = NA)
#   
#   for(i in 1:n.CUs){
#     for(p in 1:4){
#       x <- fw_output_summary[oCU[i], j, k, p, 1]
#       pCol <- col_palette[findInterval(x, col_levels)]
#       
#       points(
#         x, 
#         i + c(-0.3, -0.1, 0.1, 0.3)[p], 
#         col = pCol,
#         bg = pCol,
#         pch = c(22, 25, 21, 24)[p],
#         cex = 1.2, xpd = NA)
#       segments(
#         x0 = fw_output_summary[oCU[i], j, k, p, 2],
#         y0 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
#         x1 = fw_output_summary[oCU[i], j, k, p, 3],
#         y1 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
#         col = pCol
#       )
#       
#     } # end p
#   } # end j
#   mtext(side = 3, paste0("Fraser SEL - ", input$var, " exposure for ", input$stage))
# 
#     })
#     
#   },
#   options = list(height = 800)
# )

```


# References