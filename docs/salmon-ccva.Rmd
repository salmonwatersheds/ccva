---
title: "Climate Change Vulnerability Assessments for Pacific Salmon & Steelhead"
subtitle: "Draft Methods & Results"
author: "Steph Peacock, Salmon Watersheds Program, Pacific Salmon Foundation"
date: "`r Sys.Date()`"
bibliography: references.json
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl 
link-citations: true
header-includes:
   - \usepackage{draftwatermark}
output: 
 html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
runtime: shiny
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

<head>

<meta name="robots" content="noindex">

</head>

```{=html}
<style type="text/css">

.watermark {
  opacity: 0.2;
  position: fixed;
  top: 50%;
  left: 50%;
  font-size: 500%;
  color: #000000;
}

.blackbox {
 padding: 1em;
  background: black;
  color: white;
  border: 2px solid orange;
  border-radius: 10px;
}
.center {
  text-align: center;
}

</style>
```



# Background

Climate Change Vulnerability Assessments (CCVAs) aim to describe how climate change may impact certain valued attributes of a particular system to inform the identification and prioritization of conservation and mitigation actions. Although CCVAs have been performed for salmon [e.g., @CrozierEtAl2019ClimateVulnerabilityAssessment; @CrozierEtAl2021ClimateChangeThreatens] and steelhead [@WadeEtAl2013SteelheadVulnerabilityClimate] in the US, there is no comparable information available for Canadian-origin salmon and steelhead.

In 2021, the Pacific Salmon Foundation's [Salmon Watershed Program](https://www.salmonwatersheds.ca) received funding from the BC Salmon Restoration and Innovation Fund (BC SRIF) to, in part, undertake CCVAs for salmon in BC and share that information via the [Pacific Salmon Explorer](https://www.salmonexplorer.ca). Our goal is to quantify the relative **exposure** of different Conservation Units (CUs) to climate changes throughout their life cycles, with the aim to understand which CUs are likely to be most strongly affected and why. This information is key to informing proactive and forward-looking strategies for improving the resilience of salmon under climate change. 

Here, we describe our current approach and draft results for quantifying the exposure of salmon and steelhead CUs to climate changes.

<!-- <br> -->
<!-- ```{r ccva-framework, include=TRUE, echo = FALSE, out.width='50%', fig.align='center', fig.cap='A common conceptual framework for Climate Change Vulnerability Assessments describes three components of vulnerability, with **exposure** and **sensitivity** combining to yield the **potential impact**, which is then evaluated in light of the **adaptive capacity** of the system to arrive an overall **vulnerability**. Here we describe our efforts to quantifying potential impact (black boxes) on Pacific salmon and steelhead conservation Units.'} -->
<!-- knitr::include_graphics("ccva-framework.png") -->
<!-- ``` -->
<!-- <br> -->

# Methods

## Life stages

For each CU, we assessed exposure to climate changes for each of six life stages, defined based on life-history timing and spatial distribution. We put considerable effort into compiling life-history timing data, particularly for freshwater rearing life stages, and the details of that exercise can be found [here](https://bookdown.org/salmonwatersheds/life-cycle-timing).


| Stage                      | Timing                                                      | Spatial distribution                                                                             |
|--------------|---------------------|---------------------------------|
| Incubation                 | Start of spawning to end of fry migration                   | Accessible stream reaches with optimal gradient for spawning for the given species, using [bcfishpass](https://smnorris.github.io/bcfishpass/) model output.                                                                       |
| Freshwater rearing        | Start of fry migration to end of ocean entry                | Accessible stream reaches with optimal gradient for rearing for the given species using [bcfishpass](https://smnorris.github.io/bcfishpass/) model output, or known rearing lake for lake-type sockeye CUs. |
| Early marine               | 3 months before to 3 months after peak ocean entry date     | A 400 - 750 km buffer zone around point of marine entry                                          |
| Marine rearing             | 4 months after ocean entry to end of run timing             |  Pacific Ocean (north of 35˚N) and Bering Sea                                                                                  |
| Adult freshwater migration | Start of run timing (freshwater entry) to start of spawning | Migration route(s) from freshwater entry point to spawning stream reaches                               |
| Spawning                   | Start to end of spawning period                             | Accessible stream reaches with optimal gradient for spawning for the given species, using [bcfishpass](https://smnorris.github.io/bcfishpass/) model output.                                                                 |
Table: Salmon and steelhead life stages that are differentiated when assessing exposure, and corresponding timing and spatial distribution.

<!-- Some of these stages will extend for more than a single calendar year, meaning that multiple cohorts from a CU may overlap in their habitat use. For example, steelhead typically spend 2+ years in freshwater as juveniles, and so two or even three cohorts may be found rearing in the same habitats. These periods of overlap may have a disproportionate impact on the exposure of a CU to climate changes.  When assessing exposure of a CU, we therefore take a "cohort approach" that looks at the duration of exposure by cohort, rather than by calendar year, such that climate outputs may be "double-counted" during periods when two or more cohorts overlap. -->

## Freshwater exposure

We based our assessments of freshwater exposure on downscaled hydrologic model projections of daily mean stream temperature and flow provided by the [Pacific Climate Impacts Consortium (PCIC)](https://www.pacificclimate.org). PCIC's [Gridded Hydrologic Model Output](https://www.pacificclimate.org/data/gridded-hydrologic-model-output) does not currently display stream temperature and flow, and the output we used were provided directly (M. Schnorbus, pers. comm.) and should be considered **preliminary**. Daily projections were provided from 1945 to 2099, on a spatial grid 1/16th of a degree (\~ 30 km) for six different Global Climate Models from the CMIP5 ensemble [@TaylorEtAl2012OverviewCMIP5Experiment], under the RCP 4.5 and RCP 8.5 emissions scenarios [@PacificClimateImpactsConsortium2023VICGLBCCAQCMIP5]. The current analysis only includes the Fraser basin, but we anticipate that additional regions will be added as the hydrologic downscaling is complete.

### Stream temperature

For each spatial grid cell, we smoothed stream temperature using the 7-day running **maximum** of the modeled daily mean (`7DMax`), which approximates the 7-day mean of the daily maximum - a statistic that is widely regarded as relevant for fish exposure to high temperatures [@UnitedStatesEnvironmentalProtectionAgency2003EPARegion10]. Exposure to stream temperature was calculated in each applicable grid cell for each life stage as the number of days for which the `7DMax`exceeded the temperature threshold.

<!-- Temperature thresholds were set in each grid cell based on the distribution of temperatures over the stage window in the historical period (1970-1999). Using a temperature threshold based on the historical model output, rather than general absolute temperature thresholds that have been suggested by some agencies [@UnitedStatesEnvironmentalProtectionAgency2003EPARegion10; @OliverFidler2001WaterQualityGuideline], recognizes that the gridded model output is an abstraction and may not represent actual stream-level temperatures experienced by individual fish. Thus, comparisons of change in future periods may be more accurate. We specifically used the 90th quantile of the historical temperature distribution, based on experimental evidence that the aerobic scope of locally adapted salmon populations is related to the distribution of historical temperatures experienced by that population, and declines above the \~90th quantile of historical temperatures [@EliasonEtAl2011DifferencesThermalTolerance]. -->

Temperature thresholds were based on species- and life-stage specific guidelines from the Province of BC [@OliverFidler2001WaterQualityGuideline]. These guidelines were developed based on a literature review of studies examining the thermal tolerance and preference of salmonids. We adjusted the maximum threshold during migration to 18 ˚C for all species, as the BC Guidelines were much lower than currently observed temperatures for this lifestage.

More recent research  has suggested that salmon can be locally adapted to the historical thermal regime of their habitats, resulting in considerable intraspecific variation in thermal tolerance [@EliasonEtAl2011DifferencesThermalTolerance, @MayerEtAl2023ThermalTolerancePacific]. It is therefore likely that CUs of the same species may respond differently to increases in stream temperature. However, there is currently insufficient information on CU-specific thresholds across species and life-stages to incorporate into our analysis. It is also unknown how observed differences in current thermal tolerance among populations may relate to their adaptive capacity over longer-term climate changes. For these reasons, and for ease of interpretation, we apply the same stage- and species-specific temperature thresholds to all CUs of a given species.

```{r topt, include=TRUE, echo = FALSE}
topt <- read.csv("data/optimum-temps_BC2001.csv")
knitr::kable(topt, col.names = c("Species", "Stage", "Upper temperature threshold (˚C)"), caption = "Upper thresholds for optimal temperature range from the BC Provincial Water Quality Guidelines (Oliver 2001).")

```
^* Upper temperature thresholds for migration were 15.6 ˚C for most species (and not provided for steelhead) in the BC Water Quality Guidelines [@OliverFidler2001WaterQualityGuideline]. Given that current temperatures frequently exceed 15.6 ˚C during migration, we chose to follow other agencies (e.g., [Fraser River Environment Watch](https://www.pac.dfo-mpo.gc.ca/science/habitat/frw-rfo/index-eng.html)) and apply 18 ˚C as a guideline for temperatures above which salmon may experience negative consequences on performance.

### Stream flow

We smoothed flow using the 7-day running mean of the daily flow to bettre capture extended periods of low flow that may be harmful to fish. As for stream temperature, for each grid cell we calculated the proportion of days for each life stage that flow was below a threshold of 20% mean annual discharge (MAD). The 20% MAD threshold was calculated for each grid cell using the mean annual discharge in the historical period (i.e., mean of all daily flows in 1970-1999).

We recognize the potential importance of high flows in impacting salmon under climate change, and are currently working to determine if there is a generalizable approach to summarizing changes in high flow that are relevant to salmon. Unlike low flows, the impact of high flows (e.g. measured as some % MAD) will be substantially different depending on the hydrology of a particular stream. For example, the same discharge will result in vastly different conditions for salmon in a tight canyon versus a broad flood plain. There is also a site-specific distinction between high channel-forming flows that are beneficial for salmon and damaging high flows that can flush out eggs and junveiles or impede migrations, making it challenging to apply a common approach across a broad geography. Nonetheless, we are in the process of considering how high flows at known migration barriers, such as Hell's Gate on the Fraser River, may be incorporated into our assessments.

## Marine exposure 

Marine exposure attributes that have readily available projections include sea surface temperature, sea surface salinity, sea level rise, ocean pH, and primary productivity. We are currently working to develop relevant thresholds and assess exposure to these marine attributes.

## Summarizing output 

To capture trends in exposure due to climate change and minimize the impacts of stochasticity in the models, we averaged our exposure output over each of four 30-year periods:
* Historical (1970-1999)
* Early century (2010-2039)
* Mid century (2040-2069)
* Late century (2070-2099).

Within each period, we summarized exposure of each stage and CU as the average number of days above or below the given threshold, within the relevant timing window. We then repeated the above calculations for each of 6 different GCMs. The median exposure across GCMs for each grid cell in the mid-century period is shown in the section [Spatial details of exposure](#maps) for the selected stage and CU. 

To summarize exposure across the spatial distribution for each stage and CU, we calculated the median number of days above or below threshold across all grid cells within the spatial distribution of that stage. 

The range across GCMs captures some of the uncertainty in how climate change will progress, and differences among GCMs in their projections tend to increase further into the future. We separate projections under RCP 4.5 and RCP 8.5 emissions scenarios, which is another assessment of the uncertainty in how climate changes will progress. The median and range in output across models for the four periods and two emissions scenarios is shown in the [CU-level plots](#cu-plots).

# Results

::: {.blackbox data-latex=""}
::: {.center data-latex=""}
**This work is in the draft stage and all methods & results should be considered preliminary and subject to change.**
:::

The widgets allow exploration of **draft** results for freshwater climate exposure of salmon and steelhead Conservation Units in the Fraser region. 

:::

```{r echo = FALSE, message=FALSE, warning=FALSE, results = 'hide'}

# Load packages and outputs

library(colorRamps)
library(mapproj)
library(proj4)
library(sf)
library(dplyr)
library(wesanderson)
library(ncdf4) # package for netcdf manipulation
library(zoo) # package with rollmean function
library(shiny)
library(leaflet)

cols <- wes_palette("Darjeeling1")

###############################################################################
# Load background spatial layers
###############################################################################

#------------------------------------------------------------------------------
# Conservation Unit Boundaries
#------------------------------------------------------------------------------

cu_boundary <- readRDS("data/cu_boundary_fraser.rds")

###############################################################################
# Load variables for plotting
###############################################################################

#------------------------------------------------------------------------------
# spatial distribution
#------------------------------------------------------------------------------

# Load grid cell ids for each CU and life stage
incl.stages <- readRDS("data/PCIC_incl.rds")

# Load grid cells
grid_polys <- readRDS("data/output/grid_polys.rds")

#------------------------------------------------------------------------------
# Timing
#------------------------------------------------------------------------------

timing <- read.csv("data/freshwater_timing_fraser.csv")
species_lookup <- data.frame(
  species = c("CK", "CM", "CO", "PKE", "PKO", "SEL", "SER", "SH"),
  species_name = c("Chinook", "Chum", "Coho", "Pink", "Pink", "Sockeye", "Sockeye", "Steelhead"))
timing$species_name <- species_lookup$species_name[match(timing$species, species_lookup$species)]
  
#------------------------------------------------------------------------------
# List of CUs in the PSE
#------------------------------------------------------------------------------

cuid <- unique(timing$cuid)
cu_name <- timing$cu_name_pse[match(cuid, timing$cuid)]
species_cu_name <- paste0(timing$species_name[match(cuid, timing$cuid)], ": ", cu_name)
n.CUs <- length(cuid)

cu_norear <- which(timing$species_name[match(cuid, timing$cuid)] %in% c("Pink", "Chum"))

###############################################################################
# Load output
###############################################################################

fw_output_summary <- readRDS("data/output/fw_output_summary.rds")
# dimensions:
#   n.CUs,
#  stages,
# c("Stream temperature" "Low flow"),
#   c("hist", "early", "mid", "late"), 
# c("rcp45" "rcp85")
#   c("median" "min"    "max"))) # among models

# Spatial output
fw_spat_summary <- readRDS("data/output/fw_spat_summary.rds")

#------------------------------------------------------------------------------
# Define stages
#------------------------------------------------------------------------------

stages <- dimnames(fw_output_summary)[[2]]
stages.all <- c(stages, "early_marine", "marine_rearing")
stage.names <- c(c("Adult\nfreshwater\nmigration", "Spawning", "Incubation", "Freshwater\nrearing", "Early\nmarine", "Marine\nrearing"))
oj <- rev(c(3, 4, 5, 6, 1, 2)) # Order in which we want stages to appear

# #------------------------------------------------------------------------------
# # How much time does each CU spend in each stage?
# #------------------------------------------------------------------------------
# 
# numDays <- array(NA, dim = c(n.CUs, 4), dimnames = list(cuid, stages))
# for(i in 1:n.CUs){
#   for(j in 1:4){
#     numDays[i,j] <- timing$n.days[which(timing$cuid == cuid[i] & timing$stage == stages[j])]
#   }}

# Set pink and chum freshwater to 0 for now
fw_output_summary[cu_norear, which(stages == "fw_rearing"), , , , ] <- 0
fw_spat_summary[cu_norear, which(stages == "fw_rearing")] <- 0

```


### CU-level exposure to stream temperature and low flow {#cu-plots}

Highlights:


**Below**: The median number of days among GCMs (y-axis) that were above (for stream temperature) or below (for low flow) the threshold (see [Methods](#methods)) for each applicable life stage of a selected CU in the historical (1970-1999), early-century (2010-2039), mid-century (2040-2069), and late-century (2070-2099) periods (x-axis). The grey lines are all CUs and both emissions scenarios for the stage and the selected CU is highlighted for the RCP 4.5 (orange) and RCP 8.5 (red) scenarios, with the shaded polygon showing the range in the number of days among six different GCMs.

<!-- Users can choose between stream temperature and low flow using the left drop-down menu, and select a CU using the right drop-down menu. **Note** that these results are only available for Fraser lake-type sockeye at this point. -->

```{r echo = FALSE}

#------------------------------------------------------------------------------
# Shiny app for CU-level plots
#------------------------------------------------------------------------------

shinyApp(

  ui = fluidPage(
    br(),
    fluidRow(
      column(width = 12, 
              selectInput("cu", "Conservation Unit:",
                choices = species_cu_name)
             )
      ), # end fluidRow
    
    fluidRow(# CU plot
      column(width = 12,
             plotOutput("CUplot", height = 500))
    ) # end fluidRow
  ),

  server = function(input, output) {
    output$CUplot = renderPlot({

      # Set selections
      i <- which(species_cu_name == input$cu)

       par(mfrow = c(2, 4), mar = c(3, 4, 1, 1), oma = c(1,2,4,1))
       
       for(k in 1:2){ # For temperature and low flow
         for(j in c(3, 4, 1, 2)){
    
           plot(1:4, fw_output_summary[i, j, k, , 1, 1], "n", ylim = range(fw_output_summary[, j, k, , , 1]), xlab = "", xaxt = "n", las = 1, bty = "l", ylab = "", cex.axis = 1.2)
           axis(side = 1, at = c(1:4), c("hist", "early", "mid", "late"), cex.axis = 1.2)
           for(ii in 1:n.CUs){
             lines(1:4, fw_output_summary[ii, j, k, , 1, 1], col = grey(0.8))
             lines(1:4, fw_output_summary[ii, j, k, , 2, 1], col = grey(0.8))
           }
           
           for(r in 1:2){ # RCP4.5 or 8.5
             polygon(
               x = c(1:4, 4:1), 
               y = c(fw_output_summary[i, j, k, , r, 2], rev(fw_output_summary[i, j, k, , r, 3])),
               col = paste0(cols[c(3,1)[r]], 50),
               border = NA)
             points(1:4, fw_output_summary[i, j, k, , r, 1], "o", pch = 19, lwd = 2, col = cols[c(3,1)[r]])
           } # end rcp
           
           if(k == 1){
             mtext(side = 3, adj = 0, line = 1, paste0(c("c", "d", "a", "b")[j], ") ", c("Adult migration", "Spawning", "Incubation", "Freshwater rearing")[j]))
           }
           
          if(j == 3){
            mtext(side = 2, paste0("Days ", c("above temp.", "below flow")[k], " threshold"), line = 3)
          }
           
          } # end stage
        
         # mtext(side = 3, adj = 0, outer = TRUE, species_cu_name[i], line = 1)
  
  if(k == 1){# Add legend
  u <- par('usr')
  legend(-8, u[4] + (u[4] - u[3])*0.3, xpd = NA, lwd = 1, col = c(grey(0.8)), legend = c("All CUs, all scenarios"), cex = 1.5, bty = "n")
  legend(-3, u[4] + (u[4] - u[3])*0.3, xpd = NA, ncol = 2, lwd = 2, pch = 19, col = cols[c(3,1)], legend = c("RCP 4.5", "RCP 8.5"), cex = 1.5, bty = "n")
  }
       } # end k
  mtext(side = 1, outer = TRUE, "Time period", line = -0.5)

    })

  },
  options = list(height = 700)
)

```

### Spatial details of exposure {#maps}
 
For CUs with broad distributions and/or long migrations, there may be considerable spatial variability in exposure to changes in stream temperature and flow. The following map shows the number of days either above temperature thresholds or below low-flow thresholds in each grid cell that is relevant to the selected CU and life stage **in the mid-century period (2040-2069) under RCP 4.5**. 

```{r echo = FALSE}
#------------------------------------------------------------------------------
# set colour palette
#------------------------------------------------------------------------------
levels_max <- c(adult_migration = 100,
                spawning = 40,
                eggs_alevin = 150,
                fw_rearing  = 200)
n <- 10
col_levels <- cbind(seq(0, levels_max[1], length.out = n),
                    seq(0, levels_max[2], length.out = n),
                    seq(0, levels_max[3], length.out = n),
                    seq(0, levels_max[4], length.out = n))
              
col_palette <- paste0(colorRampPalette(colors = cols[c(5,3,1)])(n + 1))

#------------------------------------------------------------------------------
# Shiny app for CU-level plots
#------------------------------------------------------------------------------

shinyApp(

  ui = fluidPage(
    br(),
    fluidRow(
      column(width = 3,
             selectInput("var", "Climate change attribute:",
                choices = c("Stream temperature", "Low flow"))
             ),
      column(width = 6, 
              selectInput("cu", "Conservation Unit:",
                choices = species_cu_name)
             ),
      column(width = 3, 
              selectInput("stage", "Life stage:",
                          choices = c("Incubation", "Freshwater rearing", "Adult freshwater migration", "Spawning"))
             )
      ), # end fluidRow
    
    fluidRow( # Leaflet map
      column(width = 12,
             leafletOutput("map", width = "100%", height = 500)
      )
    ) # end fluidRow

  ),

  server = function(input, output) {
    
    output$map <- renderLeaflet({
      
      # Set selections
      i <- which(species_cu_name == input$cu)
       
       # Highlight all stages CU cells
        grid_polys_CU <- grid_polys[which(grid_polys$id %in% unique(c(incl.stages[[i, 1]], incl.stages[[i, 2]], incl.stages[[i, 3]], incl.stages[[i, 4]]))), ]
        
      bounds1 <- as.numeric(st_bbox(grid_polys_CU))
      # bounds0 <- as.numeric(st_bbox(cu_boundary))
      
      leaflet() %>%
        addProviderTiles(providers$Esri.WorldTopoMap,
                         options = providerTileOptions(noWrap = TRUE)) %>%
        fitBounds(lng1 = bounds1[1], lat1 = bounds1[2], lng2 = bounds1[3], lat2 = bounds1[4])  %>%
        addPolygons(data = cu_boundary[which(cu_boundary$CUID == cuid[i]),], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0) 
      
    })
    
    #----
    # Add grid colours depending on lifestage selected
    #----
    observe({

       # Set selections
        i <- which(species_cu_name == input$cu)
        k <- match(input$var, c("Stream temperature", "Low flow"))
        j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater rearing"))

        # Highlight all stages CU cells
        grid_polys_CU <- grid_polys[which(grid_polys$id %in% unique(c(incl.stages[[i, 1]], incl.stages[[i, 2]], incl.stages[[i, 3]], incl.stages[[i, 4]]))), ]
        
      bounds1 <- as.numeric(st_bbox(grid_polys_CU))
      
       myLeaf <- leafletProxy("map") %>%
          clearShapes() %>%
         clearControls()
     
        # Add all stages (no colour)
          myLeaf <-  addPolygons(myLeaf, data = grid_polys_CU, color = "#000000", weight = 1, opacity = 0.4, fillOpacity = 0)
          
          # add legend
          myLeaf <- addLegend(myLeaf, position = "topright", colors = col_palette, labels = round(c(col_levels[, j], col_levels[n, j] + diff(col_levels[, j])[1])), title = "Days", opacity = 0.8)
          
      # If a life stage is selected
      if(input$stage != "None"){
        # Highlight stage-specific grid cells
        incl <- incl.stages[[i,j]]

        grid_polys_incl <- grid_polys[match(incl.stages[[i, j]], grid_polys$id), ]

           col_polys <- col_palette[findInterval(fw_spat_summary[[i,j]][, k], col_levels[, j])]

         myLeaf <-  addPolygons(myLeaf, data = grid_polys_incl, color = col_polys, weight = 1, opacity = 1, fillOpacity = 0.8)
         
         
      } 

    # Add CU boundary
          myLeaf <- addPolygons(myLeaf, data = cu_boundary[which(cu_boundary$CUID == cuid[i]),], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0)
          
      myLeaf
      })
    
  },
  options = list(height = 800)
)

```

### Comparison among CUs
**Below**: Colour chart illustrating the median number of days in each life-stage for which a) stream temperatures are projected to be above threshold and b) low flows are projected to be below threshold in the **mid-century period (2040-2069) under RCP 4.5**. The colour scheme goes from 0 (blue) to maximum number of days among CUs for that life stage (red; adult migration = 100 days, spawning = 40 days, incubation = 150 days, freshwater rearing = 200 days).

```{r echo = FALSE, fig.height = 12}
# Order CUs according to decreasing overall exposure
 oCU <- order(apply(fw_output_summary[, , , 3, 1, 1], 1, sum, na.rm = TRUE), decreasing = FALSE)

par(mfrow = c(1,2), mar = c(6, 0, 2, 1), oma = c(0, 15, 2, 0))

for(k in 1:2){
  
  plot(c(0.5, 4.5), c(0.5, n.CUs+0.5), "n", bty = "o", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "")
  text(c(1:4), rep(-0.1, 4), stage.names[1:4], srt = 90, xpd = NA, cex =0.8, adj = 1)
  u <- par('usr')
  
  if(k == 1){
    text(rep(-6, n.CUs), c(1:n.CUs), species_cu_name[oCU], xpd = NA, adj = 0, cex = 0.8)
    abline(h = seq(0, n.CUs, 2) + 0.5, xpd = NA, col = grey(0.8))
  }
  abline(v = seq(1.5, 3.5, 1))
  
  p <- 3
  for(i in 1:n.CUs){
    for(j in 1:4){
      x <- fw_output_summary[oCU[i], j, k, p, 1, 1]
      pCol <- col_palette[findInterval(x, col_levels[, j])]
      
      polygon(x = j + c(-0.5, 0.5, 0.5, -0.5),
              y = i + c(-0.5, - 0.5, 0.5, 0.5),
              border = 1,
              col = pCol)
    }}
  mtext(side = 3, line = 0.5, c("a) Stream temperature", "b) Low flow")[k], adj = 0, cex = 0.8)
}
```

<!-- **Below**: This chart allows for a comparison of exposure (proportion of days above the temperature threshold for Stream temperature or below the a 20% MAD threshold for low flow; see [Methods](#methods)) among CUs for the selected life stage. -->

```{r echo = FALSE}
# #------------------------------------------------------------------------------
# # Shiny app for CU comparison plots
# #------------------------------------------------------------------------------
# 
# shinyApp(
# 
#   ui = fluidPage(
#     br(),
#     fluidRow(
#       column(width = 4,
#              selectInput("var", "Climate change attribute:",
#                 choices = c("Stream temperature", "Low flow"))
#              ),
#       column(width = 3, 
#               selectInput("stage", "Life stage:",
#                           choices = c("Incubation", "Freshwater rearing", "Adult freshwater migration", "Spawning"),
#                           selected = "Spawning")
#              )
#       ), # end fluidRow
#     
#    # CU comparison plot
#     plotOutput("compPlot", height = 700)
# 
#   ),
# 
#   server = function(input, output) {
#     output$compPlot = renderPlot({
# 
#       # Set selections
#       k <- match(input$var, c("Stream temperature", "Low flow"))
#       j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater rearing"))
# 
#       # Initiate plot
#       oCU <- order(fw_output_summary[ , j, k, 3, 1], decreasing = FALSE)
#   
#   par(mar = c(4, 20, 2, 1))
#   plot(c(0, 1), c(0.5, n.CUs+0.5), "n", bty = "n", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "Proportion of days")
#   u <- par('usr')
#   text(rep(-0.02*(u[2] - u[1]), n.CUs), c(1:n.CUs), cu_list$Conservation.Unit[oCU], xpd = NA, adj = 1)
#   
#   for(q in 1:n){
#     polygon(x = c(0, 1/n, 1/n, 0)+ (q-1) * 1/n, y = c(-0.5, -0.5, 0.5, 0.5), border = NA, col = col_palette[q], xpd = NA)
#   }
#   
#   axis(side = 1, tck = -0.02)
#   abline(h = c(1:n.CUs)+0.5, xpd = NA, col = grey(0.8))
#   segments(x0 = 0, y0 = 0.5, x1 = 0, y1 = n.CUs+0.5, xpd = NA)
#   segments(x0 = 0, y0 = 0.5, x1 = -10, y1 = 0.5, xpd = NA)
#   
#   for(i in 1:n.CUs){
#     for(p in 1:4){
#       x <- fw_output_summary[oCU[i], j, k, p, 1]
#       pCol <- col_palette[findInterval(x, col_levels)]
#       
#       points(
#         x, 
#         i + c(-0.3, -0.1, 0.1, 0.3)[p], 
#         col = pCol,
#         bg = pCol,
#         pch = c(22, 25, 21, 24)[p],
#         cex = 1.2, xpd = NA)
#       segments(
#         x0 = fw_output_summary[oCU[i], j, k, p, 2],
#         y0 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
#         x1 = fw_output_summary[oCU[i], j, k, p, 3],
#         y1 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
#         col = pCol
#       )
#       
#     } # end p
#   } # end j
#   mtext(side = 3, paste0("Fraser SEL - ", input$var, " exposure for ", input$stage))
# 
#     })
#     
#   },
#   options = list(height = 800)
# )

```


# References