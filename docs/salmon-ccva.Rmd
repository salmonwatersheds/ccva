---
title: "Preliminary methods & results of PSF's Climate Change Vulnerability Assessments for Pacific salmon & steelhead"
author: "Salmon Watersheds Program, Steph Peacock"
date: "`r Sys.Date()`"
bibliography: references.bib
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl 
link-citations: true
header-includes:
   - \usepackage{draftwatermark}
output: 
 html_document:
    toc: true
    theme: united
    # toc_depth: 4
    # toc_float: true
    number_sections: false
editor_options: 
  chunk_output_type: console
runtime: shiny
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

<head>

<meta name="robots" content="noindex">

</head>

```{=html}
<style type="text/css">

.watermark {
  opacity: 0.2;
  position: fixed;
  top: 50%;
  left: 50%;
  font-size: 500%;
  color: #000000;
}

.blackbox {
 padding: 1em;
  background: black;
  color: white;
  border: 2px solid orange;
  border-radius: 10px;
}
.center {
  text-align: center;
}

</style>
```


# Results

::: {.blackbox data-latex=""}
::: {.center data-latex=""}
**This work is in the draft stage and all methods & results should be considered preliminary and subject to change.**
:::

The widgets allow exploration of **draft** results for freshwater climate exposure of lake-type sockeye in the Fraser region. Please see the [Background](#background) and [Methods](#methods) sections for further information on what is shown.

:::

```{r echo = FALSE, message=FALSE, warning=FALSE, results = 'hide'}

# Load packages and outputs

library(colorRamps)
library(mapproj)
library(proj4)
library(sf)
library(dplyr)
library(wesanderson)
library(ncdf4) # package for netcdf manipulation
library(zoo) # package with rollmean function
library(shiny)
library(leaflet)

cols <- wes_palette("Darjeeling1")

###############################################################################
# Load background spatial layers
###############################################################################

#------------------------------------------------------------------------------
# Conservation Unit Boundaries: SEL
#------------------------------------------------------------------------------

# # PSF version of shapefiles
# shp_path <- "data/spatial/CU-boundaries/PSF_CUs_updatedDec2021"
# cu_boundary <- st_read(dsn = paste0(shp_path, ".shp"), promote_to_multi = FALSE) %>%
#   subset(regionname == "Fraser" & species %in% c("Lake sockeye", "Sockeye-Lake"))
# 
# saveRDS(cu_boundary, "data/cu_boundary_FraserSEL.rds")

cu_boundary <- readRDS("data/cu_boundary_FraserSEL.rds")
###############################################################################
# Create space variables for plotting
###############################################################################

grid_points0 <- read.csv("data/PCIC-grid-points_Fraser.csv")

lon <- sort(unique(grid_points0$lon))
lat <- rev(sort(unique(grid_points0$lat)))

 grid_points <- st_as_sf(grid_points0, coords = c("lon", "lat"), crs = 4269)

# Load grid cell ids for each CU and life stage
incl.stages <- readRDS("data/freshwater-grid_included-cells.rds")

# Load grid cell ids for each CU
incl.CU <- readRDS("data/freshwater-grid_included-cells_byCU.rds")

# Grid spacing
d <- 1/16
#------------------------------------------------------------------------------
# List of CUs in the PSE
#------------------------------------------------------------------------------

cu_list <- read.csv("data/cu_list.csv") %>% 
  subset(Species == "Lake sockeye" & Region == "Fraser" & Notes != "Extinct")

n.CUs <- length(unique(cu_list$Conservation.Unit))

#------------------------------------------------------------------------------
# Timing
#------------------------------------------------------------------------------

timing <- read.csv("data/freshwater_timing_FraserSEL.csv")

###############################################################################
# Load output
###############################################################################

fw_output_summary <- readRDS("data/output/fw_output_summary.rds")
# dimensions:
#   gcms$modelName,
#   cu_list$Conservation.Unit, 
#   stages,
#   c("optimalTemp", "criticalTemp", "optimalFlow", "criticalFlow"),
#   c("hist", "early", "mid", "late"), 
#   c("median", "lower", "upper")))

# Spatial output
fw_spat_summary <- readRDS("data/output/fw_spat_summary.rds")

#------------------------------------------------------------------------------
# Define stages
#------------------------------------------------------------------------------
stages <- dimnames(fw_output_summary)[[2]]
stages.all <- c(stages, "early_marine", "marine_rearing")
stage.names <- c(c("Adult\nfreshwater\nmigration", "Spawning", "Incubation", "Freshwater\njuvenile", "Early\nmarine", "Marine\nrearing"))
oj <- rev(c(3, 4, 5, 6, 1, 2)) # Order in which we want stages to appear

#------------------------------------------------------------------------------
# How much time does each CU spend in each stage?
#------------------------------------------------------------------------------
numDays <- array(NA, dim = c(n.CUs, 4), dimnames = list(cu_list$Conservation.Unit, stages))
for(i in 1:n.CUs){
  for(j in 1:4){
    numDays[i,j] <- timing$n.days[which(timing$culabel == cu_list$Conservation.Unit[i] & timing$stage == stages[j])]
  }}

```


### CU-level exposure to stream temperature and low flow
**Below left**: The proportion of days above (for stream temperature) or below (for low flow) the threshold (see [Methods](#methods)) for each applicable life stage of a selected CU in the historical (1970-1999), early-century (2010-2039), mid-century (2040-2069), and late-century (2070-2099) periods (point types; see Legend). The points and whiskers represent the median and range in the proportion of days from six different Global Climate Models (GCM). The average number of days in each life stage for the selected CU is shown on the right side of the graph. 

**Below right**: Within each GCM, the median proportion across all grid cells is used for the left figure, but the spatial distribution of exposure may be of interest. This map shows the CU boundary (solid black line) and PCIC grid cells applicable to the CU (grey rectangles). When a stage is selected from the menu above, the applicable grid cells for that stage are coloured according to the median proportion of days among all GCMs (same colour scale from 0 to 1 as the plot on the left) in the selected life stage **in the mid-century period (2040-2069)**. Note that the colour of the cells will change between, e.g., spawning and incubation because these stages are present in different times of the year.

<!-- Users can choose between stream temperature and low flow using the left drop-down menu, and select a CU using the right drop-down menu. **Note** that these results are only available for Fraser lake-type sockeye at this point. -->

```{r echo = FALSE}
#------------------------------------------------------------------------------
# set colour palette
#------------------------------------------------------------------------------
col_levels <- seq(0, 0.9, 0.1)
n <- length(col_levels)
col_palette <- paste0(colorRampPalette(colors = cols[c(5,3,1)])(n = length(col_levels) + 1))

#------------------------------------------------------------------------------
# Shiny app for CU-level plots
#------------------------------------------------------------------------------

shinyApp(

  ui = fluidPage(
    br(),
    fluidRow(
      column(width = 3,
             selectInput("var", "Climate change attribute:",
                choices = c("Stream temperature", "Low flow"))
             ),
      column(width = 6, 
              selectInput("cu", "Conservation Unit:",
                choices = cu_list$Conservation.Unit)
             ),
      column(width = 3, 
              selectInput("stage", "Highlight life stage on map:",
                          choices = c("None", "Incubation", "Freshwater juvenile", "Adult freshwater migration", "Spawning"))
             )
      ), # end fluidRow
    
    fluidRow(
      # CU plot
      column(width = 6,
             plotOutput("CUplot", height = 400)),
      # Leaflet map
      column(width = 6,
             leafletOutput("map", width = "100%", height = 600)
             )
      ) # end fluidRow

  ),

  server = function(input, output) {
    output$CUplot = renderPlot({

      # Set selections
      i <- which(cu_list$Conservation.Unit == input$cu)
      k <- match(input$var, c("Stream temperature", "Low flow"))
      j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater juvenile"))

      # Initiate plot
       par(mar =c(4, 7, 5, 3), bg = "white")
    plot(c(0, 1), c(0.5, 6.5), "n", yaxt ="n", bty = "n", xlab = "Proportion of days", ylab = "", xaxs = "i", yaxs = "i", xaxt = "n")

    # Add colour legend at bottom
    for(q in 1:n){
      polygon(x = c(0, 1/n, 1/n, 0)+ (q-1) * 1/n, y = c(0, 0, 0.5, 0.5), border = NA, col = col_palette[q], xpd = NA)
    }

    axis(side = 1, tck = -0.02)
    abline(h = c(1:6) + 0.5, xpd = NA)
    segments(x0 = 0, y0 = 0.5, x1 = 0, y1 = 6.5, xpd = NA)
    segments(x0 = seq(0, 1, 0.1), y0 = 0.5, x1 = seq(0, 1, 0.1), y1 = 6.5, col = grey(0.8), xpd = NA)
    segments(x0 = 0, y0 = 0.5, x1 = -10, y1 = 0.5, xpd = NA)

    text(rep(-0.2, 6), c(1:6), stage.names[oj], xpd = NA)

    # Grey out marine stages
    polygon(x = c(-10, 10, 10, -10), y = c(2.5, 2.5, 4.5, 4.5), col = "#00000030", border = NA, xpd = NA)
    text(rep(0.5, 2), c(3, 4), "Not Applicable", col = "white", font = 2)

    for(jj in 1:4){
      for(p in 1:4){
       pCol <- col_palette[findInterval(fw_output_summary[i, jj, k, p, 1], col_levels)]

        points(
          fw_output_summary[i, jj, k, p, 1],
          oj[jj] + c(-0.3, -0.1, 0.1, 0.3)[p],
          col = pCol,
          bg = pCol,
          pch = c(22, 25, 21, 24)[p],
          cex = 1.5, xpd = NA)
        segments(
          x0 = fw_output_summary[i, jj, k, p, 2],
          y0 = oj[jj] + c(-0.3, -0.1, 0.1, 0.3)[p],
          x1 = fw_output_summary[i, jj, k, p, 3],
          y1 = oj[jj] + c(-0.3, -0.1, 0.1, 0.3)[p],
          col = pCol,
          lwd = 1.5
        )

      } # end p
      text(1.08, oj[jj], numDays[i,jj], xpd = NA, font = 2)
    } # end jj
    
    # If a stage is selected, highlight it
    if(!is.na(j)){
      u <- par('usr')
      # Draw box around plot
      polygon(x = u[c(1,2,2,1)], y = oj[j] + c(-0.5, -0.5, 0.5, 0.5), col = NA, border = 1, lwd = 2, xpd = NA)
     }
    

    legend(-0.2, 7.2, ncol = 4, pch = c(22, 25, 21, 24), pt.cex = 1.5, col = 1, pt.bg = 1, c("Historical", "Early-century", "Mid-century", "Late-century"), xpd = NA, bty = "n", bg = NA)

    mtext(side = 3, paste0("Fraser SEL - ", input$cu, "\n", input$var), line = 3)


    })
    
    output$map <- renderLeaflet({
      
      # Set selections
      i <- which(cu_list$Conservation.Unit == input$cu)
       
       # Highlight all stages CU cells
        grid_polys_CU <- st_as_sf(
          data.frame(
            id = rep(grid_points$id[incl.CU[[i]]], each = 5),
            rep(c("SW0", "NW", "NE", "SE", "SW1"), length(incl.CU[[i]])),
            lon = c(rep(rep(lon, length(lat))[incl.CU[[i]]], each = 5) + rep(c(- d/2, -d/2, d/2,  d/2, -d/2), length(incl.CU[[i]]))),
            lat = c(rep(rep(lat, each = length(lon))[incl.CU[[i]]], each = 5) + rep(c(- d/2,  d/2, d/2, -d/2, -d/2), length(incl.CU[[i]])))
          ), coords = c("lon", "lat"), crs = 4269) %>% 
          group_by(id) %>%
          summarise(geometry = st_combine(geometry)) %>%
          st_cast("POLYGON")
        
      bounds1 <- as.numeric(st_bbox(grid_polys_CU))
      # bounds0 <- as.numeric(st_bbox(cu_boundary))
      
      leaflet() %>%
        addProviderTiles(providers$Esri.WorldTopoMap,
                         options = providerTileOptions(noWrap = TRUE)) %>%
        fitBounds(lng1 = bounds1[1], lat1 = bounds1[2], lng2 = bounds1[3], lat2 = bounds1[4])  %>%
        addPolygons(data = cu_boundary[which(cu_boundary$FULL_CU_IN == cu_list$Full.CU.Index[i]),], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0)
      
    })
    
    #----
    # Add grid colours depending on lifestage selected
    #----
    observe({

       # Set selections
        i <- which(cu_list$Conservation.Unit == input$cu)
        k <- match(input$var, c("Stream temperature", "Low flow"))
        j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater juvenile"))

        # Highlight all stages CU cells
        grid_polys_CU <- st_as_sf(
          data.frame(
            id = rep(grid_points$id[incl.CU[[i]]], each = 5),
            rep(c("SW0", "NW", "NE", "SE", "SW1"), length(incl.CU[[i]])),
            lon = c(rep(rep(lon, length(lat))[incl.CU[[i]]], each = 5) + rep(c(- d/2, -d/2, d/2,  d/2, -d/2), length(incl.CU[[i]]))),
            lat = c(rep(rep(lat, each = length(lon))[incl.CU[[i]]], each = 5) + rep(c(- d/2,  d/2, d/2, -d/2, -d/2), length(incl.CU[[i]])))
          ), coords = c("lon", "lat"), crs = 4269) %>% 
          group_by(id) %>%
          summarise(geometry = st_combine(geometry)) %>%
          st_cast("POLYGON")
        
      bounds1 <- as.numeric(st_bbox(grid_polys_CU))
      
       myLeaf <- leafletProxy("map") %>%
          # fitBounds(lng1 = bounds1[1], lat1 = bounds1[2], lng2 = bounds1[3], lat2 = bounds1[4]) %>%
			clearShapes() 
          
        # Add all stages (no colour)
          myLeaf <-  addPolygons(myLeaf, data = grid_polys_CU, color = "#000000", weight = 1, opacity = 0.4, fillOpacity = 0)
          
      # If a life stage is selected
      if(input$stage != "None"){
        # Highlight stage-specific grid cells
        incl <- incl.stages[[i,j]]

        grid_polys_incl <- st_as_sf(data.frame(
          id = rep(grid_points$id[incl], each = 5),
          rep(c("SW0", "NW", "NE", "SE", "SW1"), length(incl)),
          lon = c(rep(rep(lon, length(lat))[incl], each = 5) + rep(c(- d/2, -d/2, d/2,  d/2, -d/2), length(incl))),
          lat = c(rep(rep(lat, each = length(lon))[incl], each = 5) + rep(c(- d/2,  d/2, d/2, -d/2, -d/2), length(incl)))
        ), coords = c("lon", "lat"), crs = 4269) %>%
          group_by(id) %>%
          summarise(geometry = st_combine(geometry)) %>%
          st_cast("POLYGON")

           col_polys <- col_palette[findInterval(fw_spat_summary[[i,j]][, k], col_levels)]

         myLeaf <-  addPolygons(myLeaf, data = grid_polys_incl, color = col_polys, weight = 1, opacity = 1, fillOpacity = 0.8)
         
         
      } 

    # Add CU boundary
          myLeaf <- addPolygons(myLeaf, data = cu_boundary[which(cu_boundary$FULL_CU_IN == cu_list$Full.CU.Index[i]),], color = "#000000", weight = 1.2, opacity = 1, fillOpacity = 0)
          
      myLeaf
      })
    
  },
  options = list(height = 700)
)

```


### Comparison among CUs
**Below**: Colour chart illustrating the median exposure in the **mid-century period (2040-2069)** to a) stream temperatures above threshold and b) low flows below threshold, measured as the proportion of days for each life stage timing window. The colour scheme goes from 0 (blue) to 1 (red), the same as in the above plots.

```{r echo = FALSE, width = 8, height = 10}

# Order cUs according to decreasing overall exposure
 oCU <- order(apply(fw_output_summary[, , , 3, 1], 1, sum, na.rm = TRUE), decreasing = FALSE)

par(mfrow = c(1,2), mar = c(6, 0, 2, 1), oma = c(0, 15, 2, 0))

for(k in 1:2){
    plot(c(0.5, 4.5), c(0.5, n.CUs+0.5), "n", bty = "o", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "")
  text(c(1:4), rep(-0.1, 4), stage.names[1:4], srt = 90, xpd = NA, cex =0.8, adj = 1)
  u <- par('usr')
  if(k == 1){
    text(rep(0.1, n.CUs), c(1:n.CUs), cu_list$Conservation.Unit[oCU], xpd = NA, adj = 1, cex = 0.8)
  abline(h = c(0:n.CUs)+0.5, xpd = NA, col = grey(0.8))
  }
  abline(v = seq(1.5, 3.5, 1))
  
  p <- 3
  for(i in 1:n.CUs){
    for(j in 1:4){
      x <- fw_output_summary[oCU[i], j, k, p, 1]
      pCol <- col_palette[findInterval(x, col_levels)]
      
      polygon(x = j + c(-0.5, 0.5, 0.5, -0.5),
              y = i + c(-0.5, - 0.5, 0.5, 0.5),
              border = 1,
              col = pCol)
    }}
  mtext(side = 3, line = 0.5, c("a) Stream temperature", "b) Low flow")[k], adj = 0, cex = 0.8)
}
```

**Below**: This chart allows for a comparison of exposure (proportion of days above the temperature threshold for Stream temperature or below the a 20% MAD threshold for low flow; see [Methods](#methods)) among CUs for the selected life stage.

```{r echo = FALSE}
#------------------------------------------------------------------------------
# Shiny app for CU comparison plots
#------------------------------------------------------------------------------

shinyApp(

  ui = fluidPage(
    br(),
    fluidRow(
      column(width = 4,
             selectInput("var", "Climate change attribute:",
                choices = c("Stream temperature", "Low flow"))
             ),
      column(width = 3, 
              selectInput("stage", "Life stage:",
                          choices = c("Incubation", "Freshwater juvenile", "Adult freshwater migration", "Spawning"),
                          selected = "Spawning")
             )
      ), # end fluidRow
    
   # CU comparison plot
    plotOutput("compPlot", height = 700)

  ),

  server = function(input, output) {
    output$compPlot = renderPlot({

      # Set selections
      k <- match(input$var, c("Stream temperature", "Low flow"))
      j <- match(input$stage, c("Adult freshwater migration", "Spawning", "Incubation", "Freshwater juvenile"))

      # Initiate plot
      oCU <- order(fw_output_summary[ , j, k, 3, 1], decreasing = FALSE)
  
  par(mar = c(4, 20, 2, 1))
  plot(c(0, 1), c(0.5, n.CUs+0.5), "n", bty = "n", yaxt = "n", ylab = "", yaxs = "i", xaxs = "i", xaxt = "n", xlab = "Proportion of days")
  u <- par('usr')
  text(rep(-0.02*(u[2] - u[1]), n.CUs), c(1:n.CUs), cu_list$Conservation.Unit[oCU], xpd = NA, adj = 1)
  
  for(q in 1:n){
    polygon(x = c(0, 1/n, 1/n, 0)+ (q-1) * 1/n, y = c(-0.5, -0.5, 0.5, 0.5), border = NA, col = col_palette[q], xpd = NA)
  }
  
  axis(side = 1, tck = -0.02)
  abline(h = c(1:n.CUs)+0.5, xpd = NA, col = grey(0.8))
  segments(x0 = 0, y0 = 0.5, x1 = 0, y1 = n.CUs+0.5, xpd = NA)
  segments(x0 = 0, y0 = 0.5, x1 = -10, y1 = 0.5, xpd = NA)
  
  for(i in 1:n.CUs){
    for(p in 1:4){
      x <- fw_output_summary[oCU[i], j, k, p, 1]
      pCol <- col_palette[findInterval(x, col_levels)]
      
      points(
        x, 
        i + c(-0.3, -0.1, 0.1, 0.3)[p], 
        col = pCol,
        bg = pCol,
        pch = c(22, 25, 21, 24)[p],
        cex = 1.2, xpd = NA)
      segments(
        x0 = fw_output_summary[oCU[i], j, k, p, 2],
        y0 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
        x1 = fw_output_summary[oCU[i], j, k, p, 3],
        y1 = i + c(-0.3, -0.1, 0.1, 0.3)[p],
        col = pCol
      )
      
    } # end p
  } # end j
  mtext(side = 3, paste0("Fraser SEL - ", input$var, " exposure for ", input$stage))

    })
    
  },
  options = list(height = 800)
)

```

# Background

Climate Change Vulnerability Assessments (CCVAs) aim to describe how climate change may impact certain valued attributes of a particular system to inform the identification and prioritization of conservation and mitigation actions. Although CCVAs have been performed for salmon [e.g., @Crozier2019; @crozier2021] and steelhead [@Wade2013] in the US, there is no analogous information available for Canadian populations. In 2021, the Pacific Salmon Foundation's Salmon Watershed Program received funding from the BC Salmon Restoration and Innovation Fund (BC SRIF) to, in part, undertake CCVAs for salmon in BC and share that information via the [Pacific Salmon Explorer](https://www.salmonexplorer.ca). We are interested in understanding the potential impact of climate change on the viability of Pacific salmon and steelhead Conservation Units (CUs), with the aim to understand which CUs are likely to be most strongly affected and why.

We initially set out to quantify three components of vulnerability:

1\. Exposure to climate change, based on projected environmental variables such as stream temperature, flow, and sea surface temperature in future periods;

2\. Sensitivity of both CUs and their habitats to those projected changes, which might be influenced by characteristics such as life-history timing (CUs) or degree of degradation (habitats);

3\. Adaptive capacity of CUs to change in ways that minimize the impact of climate change, which can depend on characteristics of the CU such as populations size and life-history flexibility.

Here, we describe our current approach and draft results for quantifying the **potential impact** of climate change on salmon and steelhead CUs, defined as the combination of exposure and sensitivity (see below).

<br>
```{r ccva-framework, include=TRUE, echo = FALSE, out.width='50%', fig.align='center', fig.cap='A common conceptual framework for Climate Change Vulnerability Assessments describes three components of vulnerability, with **exposure** and **sensitivity** combining to yield the **potential impact**, which is then evaluated in light of the **adaptive capacity** of the system to arrive an overall **vulnerability**. Here we describe our efforts to quantifying potential impact (black boxes) on Pacific salmon and steelhead conservation Units.'}
knitr::include_graphics("ccva-framework.png")
```
<br>

# Methods

## Life stages

For each CU, we assessed exposure to climate changes for each of six life stages, defined based on life-history timing and spatial distribution as described in the following table. We put considerable effort into compiling life-history timing data, particularly for freshwater juvenile life stages, and the details of that exercise can be found [here](https://bookdown.org/salmonwatersheds/life-cycle-timing).

| Stage                      | Timing                                                      | Spatial distribution                                                                             |
|------------------|---------------------------|---------------------------|
| Incubation                 | Start of spawning to end of fry migration                   | Spawning Zone of Influence                                                                       |
| Freshwater juvenile        | Start of fry migration to end of ocean entry                | Freshwater rearing lake (SEL) or watersheds and downstream migration route from spawning grounds |
| Early marine               | 3 months before to 3 months after peak ocean entry date     | A 400 - 750 km buffer zone around point of marine entry                                          |
| Marine rearing             | 4 months after ocean entry to end of run timing             | North Pacific\*                                                                                  |
| Adult freshwater migration | Start of run timing (freshwater entry) to start of spawning | Migration route(s) from freshwater entry point to spawning grounds                               |
| Spawning                   | Start to end of spawning period                             | Spawning Zone of Influence                                                                       |

We note that some of these stages will exceed 365 days, meaning that multiple cohorts from a CU may overlap in habitat use. For example, if fry migration typically begins May 1st and ocean entry typically ends July 1st the following year (i.e., the juvenile rearing stage lasts 465 days), then simple calculating exposure over a 365-day window would ignore the greater influence of the period May 1st - July 1st when cohorts overlap. As such, when calculating exposure or assessing historical temperature distributions, we considered cohorts rather than years, and thus "double-counted" projected climate data over periods of overlap.

## Freshwater exposure

We based our assessments of freshwater exposure on downscaled hydrologic model projections of daily mean stream temperature and flow provided by the [Pacific Climate Impacts Consortium (PCIC)](https://www.pacificclimate.org). PCIC's [Gridded Hydrologic Model Output](https://www.pacificclimate.org/data/gridded-hydrologic-model-output) does not currently display stream temperature and flow, and the data we used were provided directly (M. Schnorbus, pers. comm.) and should be considered **preliminary**. Daily projections were provided from 1945 to 2099, on a spatial grid 1/16th of a degree (\~ 30 km) for six different Global Climate Models from the CMIP5 ensemble, under the RCP 4.5 emissions scenario [@PCIC2020]. The current analysis only includes the Fraser basin, but we anticipate that additional regions will be added as the hydrologic downscaling is complete.

### Stream temperature

We smoothed stream temperature using the 7-day running **maximum** of the modelled daily mean (`7DMax`), which is close to the 7-day mean of the daily maximum - a statistic that is widely regarded as relevant for fish exposure to high temperatures [@USEPA2003]. Exposure to stream temperature was calculated in each applicable grid cell for each life stage as the proportion of days in the stage timing window in which the `7DMax`exceeded the temperature threshold.

Temperature thresholds were set in each grid cell based on the distribution of temperatures over the stage window in the historical period (1970-1999). Using a temperature threshold based on the historical model output, rather than general absolute temperature thresholds that have been suggested by some agencies [@USEPA2003; @Oliver2001], recognizes that the gridded model output is an abstraction and may not represent actual stream-level temperatures experienced by individual fish. Thus, comparisons of change in future periods may be more accurate. We specifically used the 90th quantile of the historical temperature distribution, based on experimental evidence that the aerobic scope of locally adapted salmon populations is related to the distribution of historical temperatures experienced by that population, and declines above the \~90th quantile of historical temperatures [@Eliason2011].

### Stream flow

We smoothed flow using the 7-day running mean of the daily flow to bettre capture extended periods of low flow that may be harmful to fish. As for stream temperature, for each grid cell we calculated the proportion of days for each life stage that flow was below a threshold of 20% mean annual discharge (MAD). The 20% MAD threshold was set for each grid cell based on the mean annual discharge in the historical period (i.e., mean of all daily flows in 1970-1999).

We recognize the potential importance of high flows in impacting salmon under climate change, and are currently working to determine if there is a generalizable approach to summarizing changes in high flow that are relevant to salmon. Unlike low flows, the impact of high flows (e.g. measured as some % MAD) will be substantially different depending on the hydrology of a particular stream. For example, the same discharge will result in vastly different conditions for salmon in a tight canyon versus a broad flood plain. There is also a site-specific distinction between high channel-forming flows that are beneficial for salmon and damaging high flows that can flush out eggs and junveiles or impede migrations, making it challenging to apply a common approach across a broad geography.

## Marine exposure 

Marine exposure attributes that have readily available projections include sea surface temperature, sea surface salinity, sea level rise, ocean pH, and primary productivity. We are currently working to develop relevant thresholds and assess exposure to these marine attributes.

## Summarizing output 

We summarized exposure of life stages within a CU by taking the median proportion of days above threshold across all grid cells within the spatial distribution of that stage. We then repeated the above calculations for each of 6 different GCMs, and report the median and range in the proportion of days across the GCMs.

The range across GCMs captures some of the uncertainty in how climate change will progress, and differences among GCMs in their projections tend to increase further into the future. This range does not account for the spatial variability in exposure across grid cells - we also calculated the median exposure in each grid cell across GCMs to provide a visual representation on a map of how geographically variable exposure was.

# References